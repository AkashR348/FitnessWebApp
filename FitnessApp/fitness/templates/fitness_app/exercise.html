{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1>Weekly Exercise Tracker</h1>
    
    <div class="row">
        {% for day, data in week_data.items %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5>{{ day|date:"l" }} - {{ day|date:"M d, Y" }}</h5>
                        <p>Total Time: <span id="total-duration">{{ data.total_time }}</span> minutes</p>
                        <p>Total Calories: <span id="total-calories">{{ data.total_calories }}</span> kcal</p>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addExerciseModal" data-day="{{ day }}">Add Exercise</button>
                        <button class="btn btn-link btn-sm view-exercises" data-toggle="modal" data-target="#viewExercisesModal" data-day="{{ day }}">View Exercises</button>

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Add Exercise Modal -->
<div class="modal fade" id="addExerciseModal" tabindex="-1" aria-labelledby="addExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addExerciseModalLabel">Add Exercise for <span id="modal-date"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addExerciseForm">
                    {% csrf_token %}
                    <input type="hidden" id="exercise-date" name="date">
                    <div class="form-group">
                        <label for="exercise-name">Exercise Name</label>
                        <input type="text" class="form-control" id="exercise-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="exercise-duration">Duration (minutes)</label>
                        <input type="number" class="form-control" id="exercise-duration" name="duration" required>
                    </div>
                    <div class="form-group">
                        <label for="exercise-calories">Calories Burned</label>
                        <input type="number" class="form-control" id="exercise-calories" name="calories_burned" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Exercise</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Exercises Modal -->
<div class="modal fade" id="viewExercisesModal" tabindex="-1" aria-labelledby="viewExercisesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewExercisesModalLabel">Exercises for <span id="view-modal-date"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="exercise-list-content">
                <!-- Exercise list for the selected day will be dynamically loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (necessary for AJAX requests) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        // CSRF setup for Django AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Handle form submission for adding a new exercise
        $('#addExerciseForm').on('submit', function (e) {
            e.preventDefault();

            $.ajax({
                type: 'POST',
                url: '{% url "fitness_app:create_exercise" %}',
                data: $(this).serialize(),
                success: function (response) {
                    if (response.success) {
                        $('#addExerciseModal').modal('hide');  // Hide modal on success
                        $('#addExerciseForm')[0].reset();  // Reset the form fields

                        // Add the new exercise to the View Exercises modal
                        const exercise = response.exercise;
                        const exerciseHtml = 
                        `
                            <li class="list-group-item">
                                <h5>${exercise.name}</h5>
                                <p>Duration: ${exercise.duration} minutes</p>
                                <p>Calories Burned: ${exercise.calories_burned} kcal</p>
                                <p>Start Time: ${exercise.start_time}</p>
                                <p>Date: ${exercise.date}</p>
                            </li>
                        `;
                        $('#exercise-list-content').append(exerciseHtml);  // Append new exercise

                        // Optionally update daily totals in the box
                        const currentTotalCalories = parseInt($('#total-calories').text(), 10) || 0;
                        const currentTotalDuration = parseInt($('#total-duration').text(), 10) || 0;
                        $('#total-calories').text(currentTotalCalories + exercise.calories_burned);
                        $('#total-duration').text(currentTotalDuration + exercise.duration);
                    } else {
                        alert("An error occurred. Please check your input and try again.");
                    }
                },
                error: function () {
                    alert("An error occurred. Please try again.");
                }
            });
        });
    });
</script>
{% endblock%}
