
{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1>Weekly Food Tracker</h1>
    
    <div class="row">
        {% for day, data in week_food_data.items %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5>{{ day|date:"l" }} - {{ day|date:"M d, Y" }}</h5>
                        <p>Breakfast:<span id="total_breakfast_{{ day|date:'Ymd' }}"> {{ data.meal_totals.breakfast }}</span> kcal</p>
                        <p>Lunch: <span id="total_lunch_{{ day|date:'Ymd' }}">{{ data.meal_totals.lunch }}</span> kcal</p>
                        <p>Dinner: <span id="total_dinner_{{ day|date:'Ymd' }}">{{ data.meal_totals.dinner }}</span> kcal</p>
                        <p>Snacks: <span id="total_snacks_{{ day|date:'Ymd' }}">{{ data.meal_totals.snack }}</span> kcal</p>
                        <p><strong>Total Calories:</strong> <span id="total_calories_{{ day|date:'Ymd' }}">{{ data.total_calories }}</span> kcal</p>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addFoodModal" onclick="setDate('{{ day|date:'Y-m-d' }}')">Add Food</button>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#viewFoodsModal" onclick="viewData('{{ day|date:'Y-m-d' }}')">View Food Entries</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Add Food Modal -->
<div class="modal fade" id="addFoodModal" tabindex="-1" aria-labelledby="addFoodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFoodModalLabel">Add Food for <span id="food-modal-date"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addFoodForm" action="{% url 'fitness_app:create_foodentry' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="food-date" name="date">
                    <div class="form-group">
                        <label for="food-meal-type">Meal Type</label>
                        <select class="form-control" id="food-meal-type" name="meal_type" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="food-calories">Calories</label>
                        <input type="number" class="form-control" id="food-calories" name="calories" required>
                    </div>
                    <button id="save_button" type="submit" class="btn btn-primary">Save Food Entry</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Food Entries Modal -->
<div class="modal fade" id="viewFoodsModal" tabindex="-1" aria-labelledby="viewFoodsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewFoodsModalLabel">Food Entries for <span id="view-food-modal-date"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="food-list-content">
                <!-- Food entries for the selected day will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    var button = document.getElementById('save_button');
    button.addEventListener('click',saveData(event),false);



    function setDate(date) {
        document.getElementById("food-date").value = date;
        document.getElementById("food-modal-date").textContent = date;
    }

    // Save food entry and update meal totals
    function saveData(event) {
        event.preventDefault();

        const date = document.getElementById("food-date").value;
        const mealType = document.getElementById("food-meal-type").value;
        const calories = parseInt(document.getElementById("food-calories").value);

        // Retrieve existing food entries from sessionStorage or initialize an empty array
        let foodEntries = JSON.parse(sessionStorage.getItem("foodEntries")) || {};

        // Initialize the date entry if it doesn't exist
        if (!foodEntries[date]) {
            foodEntries[date] = { breakfast: 0, lunch: 0, dinner: 0, snack: 0, entries: [] };
        }

        // Add the new food entry to the specific meal type
        foodEntries[date][mealType] += calories;

        // Add entry to the general list for viewing
        foodEntries[date].entries.push({ mealType, calories });

        // Save the updated food entries back to sessionStorage
        sessionStorage.setItem("foodEntries", JSON.stringify(foodEntries));

        // Update meal type totals on the page
        updateMealTotals(date);

        // Close the Add Food modal and reset the form
        $('#addFoodModal').modal('hide');
        document.getElementById("addFoodForm").reset();
    }

    // Update the displayed meal type totals for a specific date
    function updateMealTotals(date) {
        const dateId = date.replace(/-/g, '');  // Format the date for use in element IDs
        const foodEntries = JSON.parse(sessionStorage.getItem("foodEntries")) || {};
        const dayData = foodEntries[date] || { breakfast: 0, lunch: 0, dinner: 0, snack: 0 };

        // Update the displayed totals for each meal type
        document.getElementById(`total_breakfast_${dateId}`).textContent = dayData.breakfast || 0;
        document.getElementById(`total_lunch_${dateId}`).textContent = dayData.lunch || 0;
        document.getElementById(`total_dinner_${dateId}`).textContent = dayData.dinner || 0;
        document.getElementById(`total_snacks_${dateId}`).textContent = dayData.snack || 0;

        // Update the total calories for the day
        const totalCalories = dayData.breakfast + dayData.lunch + dayData.dinner + dayData.snack;
        document.getElementById(`total_calories_${dateId}`).textContent = totalCalories;
    }

    // View all food entries for the selected date in the modal
    function viewData(date) {
        const foodEntries = JSON.parse(sessionStorage.getItem("foodEntries")) || {};
        const dayEntries = foodEntries[date]?.entries || [];

        // Get the container element for the food list in the modal
        const foodListContent = document.getElementById("food-list-content");

        // Clear the previous list
        foodListContent.innerHTML = "";

        // Populate the modal with each food entry for the selected date
        dayEntries.forEach((entry, index) => {
            const foodItem = document.createElement("div");
            foodItem.classList.add("food-item");
            foodItem.innerHTML = `
                <p><strong>Entry ${index + 1}</strong></p>
                <p><strong>Meal Type:</strong> ${entry.mealType}</p>
                <p><strong>Calories:</strong> ${entry.calories} kcal</p>
                <hr>
            `;
            foodListContent.appendChild(foodItem);
        });

        // Set the date in the view modal header
        document.getElementById("view-food-modal-date").textContent = date;
    }
</script>
{% endblock content %}